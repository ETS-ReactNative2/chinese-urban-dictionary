<head>
	<link href="https://fonts.googleapis.com/css?family=Oswald|Noto+Sans+TC&display=swap" rel="stylesheet">
	<style type="text/css">
	</style>
</head>
<body>
	<div class="newEntryPanel">
		<label for="phrase">Phrase: </label>
		<br>
		<div class="inputField" id="phraseField">
			<input type="text" id="phrase" value="<%=@entry.phrase%>">
		</div>
		<br>
		<label for="pinyin">Pinyin: </label>
		<br>
		<div class="inputField" id="pinyinField">
			<input type="text" id="pinyin" value="<%=@entry.pinyin%>">
		</div>
		<br>
	</div>
	<script type="text/javascript">
		var cursorFieldPos = 0;
		var initializeIME = function(event){
			// TRIGGER the IME ONLY IF the character is a-z
			if (event.which<65 || event.which>90) {return;}
			cursorFieldPos = this.selectionStart;
			// TRACK the position of the results box
		  var caret = getCaretCoordinates(this, this.selectionEnd);
		  var cursorPos= $("#phrase").prop('selectionStart');
		  $('#phraseField').append(
	      $('<div>', { id: 'imeBubble'})
		  );
		  $('#imeBubble').append(
	      $('<input>', { id: 'phraseEntry', type: 'text'})
		  );
		  $('#imeBubble').append(
	      $('<div>', { id: 'results'})
		  );
		  var inputVertPosition = this.getBoundingClientRect().top + caret.height + + caret.top + 5;
		  var inputHorizPosition = this.getBoundingClientRect().left + caret.left + 5;
		  $("div#imeBubble")
		  	.css({
		  		"background-color":"gray",
		  		"z-index": 99,
		  		"color":"black",
		  		"position":"absolute",
		  		"top":inputVertPosition+"px",
		  		"left":inputHorizPosition+"px",
		  		"padding":"10px",
		  	});
			$('input#phraseEntry').on('blur', removeIME);
		  $('input#phraseEntry').focus();
		  $('input#phraseEntry').on('keyup', renderIME);
		}
		var removeIME = function(){
			if (!$('.resultsList').is(":focus")){
				document.getElementById("imeBubble").remove();
			}
		}

		var renderIME = function(e){
			// GET imeBubble
			var resultsList = [];
			var inputEntryText = this.value;
			var promise = getChinese(inputEntryText);
			promise.then(data => {
				resultsList = data[1][0][1];
				document.getElementById('results').innerHTML = resultsList.map(
					function(x, i){
						return '<div>'+(i+1)+") "+x+"</div>";
					}
				).join(' ');
				if (e.which==13) {
					var insertableText = resultsList[0];
					var firstSlice = $('input#phrase').val().slice(0,cursorFieldPos);
					var secondSlice = $('input#phrase').val().slice(cursorFieldPos);
					$('input#phrase').val(firstSlice+insertableText+secondSlice);
					console.log(firstSlice+insertableText+secondSlice);
					$('#imeBubble').remove();
				}
			}).catch(error => console.log('Error:', error));
		}

		var insertPhrase = function(event) {
			if (event.which==13) {
								
						// window.addEventListener("load", function() {
		// 	var input document.getElementsByTagName("input");
		// 	input[0].addEventListener("keydown", function() {
		// 		alert("Caret position: " + this.selectionStart);
		// 	});
		// }); 
			}
		};
		function insertInPosition(){}

		var inputCollection = document.getElementsByTagName("input");
		inputCollection[0].addEventListener('keydown', initializeIME);

		function getChinese(pinyin) {
			return $.ajax({
				url: "https://www.google.com/inputtools/request?ime=pinyin&ie=utf-8&oe=utf-8&app=translate&num=5&text="+pinyin.toLowerCase(),
			});
		}

	</script>
</body>


<!--
		inputCollection[0].onkeypress = function(evt) {
		   evt = evt || window.event;
		   var charCode = evt.which || evt.keyCode;
		   var charStr = String.fromCharCode(charCode);
		   if (/[a-z0-9]/i.test(charStr)) {
		   }
		};
 -->